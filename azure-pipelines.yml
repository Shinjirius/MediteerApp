# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'
  containerRegistry: 'martinwdejong_container_registry'
  imageName: 'mediteer_app'

stages:
- stage: "BuildAndTest"
  displayName: "BuildAndTest"
  jobs:
    - job: "BuildAndTest"
      steps:
      # Build and runs tests
      - task: DotNetCoreCLI@2
        inputs:
          command: test
          projects: '*Tests/*.csproj'
          arguments: '--configuration $(buildConfiguration)'

      # Build project
      - script: dotnet build --configuration $(buildConfiguration)
        displayName: 'dotnet build $(buildConfiguration)'

- stage: "PublishArtifect"
  displayName: "PublishArtifect"
  jobs:
    - job: "PublishArtifect"
      steps:
      # Publish the artifect (so it can be deployed)
      - task: DotNetCoreCLI@2
        displayName: 'dotnet publish --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        inputs:
          command: publish
          publishWebProjects: false
          projects: MediteerApp/MediteerApp.csproj
          arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
          zipAfterPublish: true

      - task: PublishBuildArtifacts@1
        displayName: 'publish artifacts'

- stage: "BuildAndPushDocker"
  displayName: "BuildAndPushDocker"
  jobs:
    - job: "BuildDocker"
      steps:
      # Publish the artifect (so it can be deployed)
      - task: DockerInstaller@0
        displayName: Install Docker on VM
        inputs:
          dockerVersion: 17.09.0-ce
          releaseType: stable
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          command: login
          containerRegistry:  $(containerRegistry) 
      - task: Docker@2
        displayName: Build and Push Docker Image
        inputs:
          repository: $(imageName) 
          command: buildAndPush
          Dockerfile: 'MediteerApp/Dockerfile'
